# /nxs.tasks

Decompose a High-Level Design into implementable GitHub issues with detailed Low-Level Design for each task.

## Purpose

Breaks down an HLD into sized, sequenced implementation tasks. Each task gets its own LLD generated by the `nxs-architect` agent. Includes automatic consistency analysis, auto-remediation, and GitHub issue creation.

## When to Use

- After creating HLD with `/nxs.hld`
- When ready to convert design into backlog
- Before starting implementation
- **Resume mode**: To continue from a previous session that stopped at the Review Checkpoint

## Prerequisites

**Required Files**:
- `HLD.md` (from `/nxs.hld`)
- `epic.md` (in same directory)
- `docs/system/delivery/task-template.md` (task structure)

**GitHub Setup**:
- `gh` CLI authenticated
- Repository configured in `docs/system/delivery/config.json`

## Usage

### Option 1: With Open HLD File
```bash
# Open HLD.md in IDE, then run:
/nxs.tasks
```

### Option 2: With File Path
```bash
/nxs.tasks docs/product/features/03-space-scoped-tags/HLD.md
```

### Option 3: Resume Mode
```bash
# Continue from a previous session:
/nxs.tasks path/to/tasks/task-review.md
```

## Resume Mode

When `task-review.md` is provided as input, the command enters **resume mode** to continue from a previous session that stopped at the Review Checkpoint.

**Validation**:
1. Verifies directory structure (epic.md, HLD.md, tasks/*.md)
2. Extracts epic context from `epic.md` frontmatter
3. Parses `task-review.md` for metrics (remediation stats, remaining issues, coverage)
4. Skips directly to Review Checkpoint (Step 6)

**Use case**: Session timed out or you aborted to make manual edits and now want to continue.

## What It Does

### Phase 1: Create Epic Issue

Before task decomposition, creates a GitHub issue for the parent epic:

1. Locates `epic.md` in same directory as HLD
2. Runs `nxs-gh-create-epic` skill
3. Updates `epic.md` frontmatter with `link: "#42"`
4. Stores issue number for task parent reference

### Phase 2: Extract Context & Persist to Scratchpad

Creates a scratchpad directory to store intermediate data for explicit data passing between agents.

**Scratchpad location**: `tasks/.scratchpad/`

**Context files created**:

| File | Contents |
|------|----------|
| `scope-context.json` | Out-of-scope items from epic.md and HLD.md, assumptions, dependencies, constraints |
| `terminology-glossary.json` | Canonical component names, entity names, endpoints, technical terms from HLD |
| `user-constraints.json` | User-provided constraints from command arguments (e.g., "dependencies already installed") |

**Why scratchpad?** Sub-agents cannot access parent conversation context. Explicit file-based data passing ensures agents receive the constraints they need to respect.

### Phase 3: Decompose into Tasks

Delegates to `nxs-decomposer` agent with explicit context passing:

**Inputs passed**:
- HLD file path
- Epic issue number
- Scope context path
- Terminology glossary path
- User constraints path

**Decomposition rules**:

**Size Constraint**: Each task ≤2 days for one engineer

**Consistency Rule**: After each task, system must be in valid state (tests pass, build succeeds, no broken features)

**Task Categories**:
1. Infrastructure/Setup
2. Data Layer
3. Core Logic
4. API/Interface
5. Integration
6. Polish

**Scope Validation**: The decomposer validates each task against:
- Out-of-scope items (from epic and HLD)
- Canonical terminology (from glossary)
- User constraints

**Handling scope violations**:
- If tasks implement out-of-scope functionality, you're prompted
- Choose: "Remove violating tasks and proceed?" or "Abort and revise scope?"
- Command will NOT proceed without explicit confirmation

**Output**: Structured JSON saved to `tasks/.scratchpad/decomposition.json`

### Phase 4: Generate Task Files

Task file generation involves invoking the architect for LLD content, then running a generation script.

#### 4.1 Generate LLD Content

For each task from the decomposer, invokes `nxs-architect` in LLD-elaboration mode:

**Architect generates** (treating HLD as authoritative):
- Files to create/modify with purposes
- Key TypeScript interfaces/types
- Key decisions with rationale (extracted from HLD)
- Implementation notes (patterns, edge cases, testing guidance)
- Task-specific acceptance criteria

**Fallback**: If architect fails for a task, the response is set to `null` and the generation script uses placeholder content.

#### 4.2 Prepare Input JSON

Assembles all task data into a structured JSON file:

```json
{
    "epic_number": 42,
    "epic_title": "Space-Scoped Tags",
    "epic_type": "enhancement",
    "output_dir": "docs/product/features/03-space-scoped-tags/tasks",
    "tasks": [
        {
            "sequence": 1,
            "title": "Create tags database schema",
            "category": "Data Layer",
            "summary": "One paragraph summary...",
            "effort": "S",
            "labels": ["database"],
            "blocked_by": [],
            "blocks": [2, 3],
            "architect_response": "### Files\n\n- `migrations/...`..."
        }
    ]
}
```

#### 4.3 Run Generation Script

Executes the task file generation script:

```bash
python .claude/skills/nxs-generate-tasks/scripts/generate_task_files.py /tmp/tasks-input-{epic_number}.json
```

**Script handles**:
- Reading the task template from `docs/system/delivery/task-template.md`
- Validating labels against `docs/system/delivery/task-labels.md`
- Substituting template variables
- Creating task files with proper frontmatter

**Output**: Task files in `{epic_dir}/tasks/TASK-{EPIC}.{NN}.md`

**Error Handling**:
- If script returns error, reports to user and stops
- If `fallbacks_used > 0` in response, warns that some tasks have placeholder LLD content

### Phase 5: Consistency Analysis & Auto-Remediation

Invokes `nxs-analyzer` agent with auto-remediate mode.

**Auto-Fixed**:
- Superfluous tasks (barrel files, verification-only, <1hr effort)
- Terminology drift (normalizes to HLD canonical terms)
- Task numbering gaps (renumbers after merges)
- Dependency updates (fixes `blocked_by`/`blocks` after merges)

**Manual Review Required**:
- Circular dependencies
- Conflicting implementations
- Coverage gaps (user stories without tasks)
- Scope drift between epic/HLD/tasks

**Output**: `tasks/task-review.md` with findings classified by severity and remediation type.

### Phase 6: Review Checkpoint

**MANDATORY STOP** - Waits for user confirmation before creating GitHub issues.

**For fresh runs**:
```
Generated {N} tasks in tasks/
Auto-remediation applied: {X} tasks merged, {Y} terminology fixes
Remaining issues: {critical}/{high}/{medium}/{low}
Coverage: {X}%

See task-review.md for full analysis.

✅ No blocking issues
   -OR-
⛔ CRITICAL ISSUES - Resolve before proceeding
   -OR-
⚠️ HIGH priority issues - Review recommended
```

**For resume mode**:
```
Resuming from previous session.
{N} task files found in tasks/
[Metrics from task-review.md displayed]
```

**Options**:
- `continue` - Create GitHub issues for all tasks
- `skip 03, 05` - Create issues excluding specified tasks
- `abort` - Cancel to address findings (files preserved)

### Phase 7: Create Task Issues

When user chooses `continue`:

1. Uses `nxs-gh-create-task` skill to bulk-create issues
2. Sets labels from task frontmatter
3. Links to epic issue as parent
4. Generates `./tasks.md` summary with:
   - Task list grouped by phase
   - Mermaid dependency graph
   - Parallelization opportunities
   - Total effort estimate

### Phase 8: Update Epic

Adds `## Implementation Plan` section to `epic.md` with link to `tasks.md`.

### Phase 9: Next Steps

Informs user that:
1. Task breakdown is complete
2. Scratchpad directory (`tasks/.scratchpad/`) is retained for debugging
3. Run `/nxs.close` after implementation to generate PIR and clean up

## Task File Structure

Generated files follow template from `docs/system/delivery/task-template.md`:

```markdown
---
title: "TASK-42.01: Create tags database schema"
labels: [database, migration]
parent: "#42"
project: "User Tagging System"
---

## Summary
Create PostgreSQL schema for tags with space-scoped unique constraints.

## Dependencies
- Blocked by: None
- Blocks: TASK-42.02

## Git Workspace
- Worktree: `../nexus-worktrees/42`
- Branch: `feat/42-space-scoped-tags`

## Low-Level Design

### Files
- `migrations/20260123_create_tags.sql` - Tag table migration
- `migrations/20260123_create_content_tags.sql` - Junction table

### Interfaces/Types
```typescript
// N/A for migration task
```

### Key Decisions
| Decision | Rationale | Alternatives |
|----------|-----------|--------------|
| UUID for IDs | Distributed generation, no collisions | Auto-increment (rejected - migration issues) |

### Implementation Notes
- Use UUID v4 for tag IDs
- Add composite index on (space_id, name)
- Foreign keys with CASCADE delete

## Acceptance Criteria
- [ ] tags table created with all columns
- [ ] Unique constraint prevents duplicate tag names per space
- [ ] Migration runs successfully on clean database
- [ ] All existing tests pass

## Estimated Effort
2 hours
```

## Output Artifacts

**Created**:
- `tasks/` folder
- `tasks/TASK-{EPIC}.{NN}.md` (one per task)
- `tasks/task-review.md` (analysis report)
- `tasks/.scratchpad/` (intermediate data for debugging)
- `tasks.md` (summary with dependency graph)
- GitHub issues (if confirmed)

**Updated**:
- `epic.md` frontmatter (adds `link` field)
- `epic.md` content (adds Implementation Plan section)

## Common Issues

### HLD Not Found

**Problem**: "Cannot locate HLD file"

**Solutions**:
1. Open HLD.md in IDE
2. Provide path: `/nxs.tasks path/to/HLD.md`
3. Ensure HLD exists in epic directory

### Scope Violations Detected

**Problem**: "Tasks implement out-of-scope functionality"

**Solutions**:
1. Review the violations shown
2. Choose to remove violating tasks and proceed
3. Or abort and revise scope in epic.md/HLD.md first

### Terminology Deviations

**Problem**: "Component names don't match glossary"

**Solutions**:
1. This is auto-fixed in most cases
2. Check `task-review.md` for terminology normalization log
3. Severe cases may require manual HLD/task revision

### Pre-Generation Validation Failed

**Problem**: "Task count mismatch" or "Constraint violation"

**Solutions**:
1. Review the specific failures reported
2. Check scratchpad files for debugging
3. Re-run after fixing source issues

### Critical Issues in Review

**Problem**: "CRITICAL ISSUES FOUND"

**Solutions**:
1. Read `tasks/task-review.md` for details
2. Fix critical issues (circular dependencies, conflicts)
3. Re-run `/nxs.tasks` or `/nxs.analyze` after fixes

## Review Checkpoint Options

### `continue`
Create GitHub issues for all tasks.

### `skip 03, 05`
Create issues excluding specified task numbers. Useful if you want to manually revise certain tasks first.

### `abort`
Cancel issue creation. Files are preserved. Re-run `/nxs.tasks path/to/tasks/task-review.md` to resume from checkpoint.

## Next Steps

After task generation:

1. **Review task files**: Validate LLD makes sense
2. **Check task-review.md**: Address medium/low priority issues
3. **Start implementation**: Use `/nxs.dev <issue-number>` on first unblocked task

## Tips

**Resume After Abort**: Use `/nxs.tasks path/to/tasks/task-review.md` to resume from the Review Checkpoint without regenerating tasks.

**Scratchpad for Debugging**: The `tasks/.scratchpad/` directory contains all intermediate data. Useful for understanding what context was passed to agents.

**Read the Template**: The command uses your custom `task-template.md`. The generation script (`nxs-generate-tasks`) reads and validates the template, so customizations are automatically respected.

**Script-Based Generation**: Task files are generated by a Python script that handles template variable substitution and label validation. If you see errors about invalid labels, check `docs/system/delivery/task-labels.md`.

**Trust Auto-Remediation**: Superfluous task detection is conservative. Review `task-review.md` to understand what was merged.

**Fix Critical Issues**: Don't skip critical findings. They indicate fundamental problems (circular dependencies, conflicts).

**Sequential Implementation**: Implement tasks in number order. Dependencies are pre-calculated.

**Git Workspace Pre-Configured**: Each task has worktree path and branch name. `/nxs.dev` uses these automatically.

## Related Commands

- [/nxs.hld](nxs-hld.md) - Generate HLD (run first)
- [/nxs.dev](nxs-dev.md) - Implement task (run after)
- [/nxs.analyze](nxs-analyze.md) - Re-validate consistency

## Related Concepts

- [Task Decomposition](../concepts/task-decomposition.md) - Sizing and sequencing principles
- [Agents](../reference/agents.md) - nxs-decomposer and nxs-architect roles
